{"version":3,"sources":["D2App/actions/Actions.module.css","D2App/clearForm/FormSection.module.css","D2App/clearForm/ClearForm.module.css","D2App/views/Home.module.css","D2App/actions/Actions.js","D2App/clearForm/FormSection.js","D2App/clearForm/ClearForm.js","D2App/storage/clearStoragesByKey.js","D2App/storage/reservedStorageKeys.js","D2App/storage/useClearableStorageKeys.js","D2App/storage/getClearableKeys.js","D2App/indexedDb/dbExists.js","D2App/indexedDb/deleteDb.js","D2App/indexedDb/dhis2DatabaseNames.js","D2App/indexedDb/getCaptureAppUserDatabases.js","D2App/indexedDb/openDb.js","D2App/indexedDb/getKeyFromObjectStore.js","D2App/indexedDb/useClearableDatabaseKeys.js","D2App/indexedDb/getClearableDatabases.js","D2App/views/Home/deleteValues.js","D2App/indexedDb/clearDatabasesByKey.js","D2App/views/Home.js","D2App/views/Home/formatDeleteValues.js","D2App/App.js"],"names":["module","exports","Actions","children","className","styles","actions","formatKeyToOption","key","label","value","FormSection","deselectButtonLabel","emptyMessage","form","headline","selectButtonLabel","storageKeys","storageName","storageDataTestName","toLowerCase","container","data-test","groupHeadline","length","onClick","change","dataTest","name","options","map","component","CheckboxGroup","validate","values","errors","localStorageKeys","sessionStorageKeys","indexedDatabaseKeys","FORM_ERROR","i18n","t","ClearForm","onSubmit","initialValues","handleSubmit","submitFailed","batch","selectAll","deselectAll","disabled","destructive","type","formErrors","error","defaultProps","clearStoragesByKey","storage","keys","forEach","removeItem","reduce","success","getItem","reservedStorageKeys","Object","Storage","prototype","useClearableStorageKeys","existingKeys","setExistingKeys","useState","onStorageChange","useCallback","existing","filter","includes","getClearableKeys","useEffect","refetch","dbExists","Promise","resolve","reject","alreadyExists","request","window","indexedDB","open","onsuccess","result","close","deleteDb","then","onerror","onupgradeneeded","exists","deleteDatabase","dhis2DatabaseNames","getCaptureAppUserDatabases","async","db","dbNames","captureDbExists","data","storeName","transaction","objectStore","get","event","target","e","getKeyFromObjectStore","useClearableDatabaseKeys","refetchCounter","setRefetchCounter","loading","setLoading","setData","staticDatabases","userDatabases","all","catch","operation","deleteValues","localStorage","sessionStorage","clearSessionStorageByKeys","clearDatabasesByKey","Home","refetchLocalStorageKeys","refetchSessionStorageKeys","refetchIndexedDatabaseKeys","showContent","message","formattedValues","shouldDeleteUserDatabases","formatDeleteValues","App","colors","spacers"],"mappings":"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","file":"static/js/app.6daa051c.chunk.js","sourcesContent":["// extracted by mini-css-extract-plugin\nmodule.exports = {\"actions\":\"Actions_actions__1BcAq\"};","// extracted by mini-css-extract-plugin\nmodule.exports = {\"container\":\"FormSection_container__20Fh9\",\"groupHeadline\":\"FormSection_groupHeadline__3kOHC\"};","// extracted by mini-css-extract-plugin\nmodule.exports = {\"actions\":\"ClearForm_actions__2P0VA\",\"action\":\"ClearForm_action__243lJ\",\"groupHeadline\":\"ClearForm_groupHeadline__2C-rb\"};","// extracted by mini-css-extract-plugin\nmodule.exports = {\"container\":\"Home_container__2aYrM\",\"headline\":\"Home_headline__2WsGZ\"};","import { ButtonStrip } from '@dhis2/ui-core';\nimport React from 'react';\nimport propTypes from '@dhis2/prop-types';\nimport styles from './Actions.module.css';\nexport const Actions = ({\n  children\n}) => <div className={styles.actions}>\n        <ButtonStrip>{children}</ButtonStrip>\n    </div>;\nActions.propTypes = {\n  children: propTypes.node\n};","import { Button } from '@dhis2/ui-core';\nimport { Field, CheckboxGroup } from '@dhis2/ui-forms';\nimport React from 'react';\nimport propTypes from '@dhis2/prop-types';\nimport { Actions } from '../actions/Actions';\nimport styles from './FormSection.module.css';\n\nconst formatKeyToOption = key => ({\n  label: key,\n  value: key\n});\n\nexport const FormSection = ({\n  deselectButtonLabel,\n  emptyMessage,\n  form,\n  headline,\n  selectButtonLabel,\n  storageKeys,\n  storageName\n}) => {\n  const storageDataTestName = storageName.toLowerCase();\n  return <div className={styles.container} data-test={`dhis2-cachecleaner-${storageDataTestName}`}>\n            <h2 className={styles.groupHeadline}>{headline}</h2>\n\n            {!storageKeys.length && <p data-test=\"dhis2-cachecleaner-emptystoragemessage\">\n                    {emptyMessage}\n                </p>}\n\n            {!!storageKeys.length && <Actions>\n                    <Button onClick={() => form.change(storageName, storageKeys)} dataTest={`dhis2-cachecleaner-formsection-selectall`}>\n                        {selectButtonLabel}\n                    </Button>\n\n                    <Button onClick={() => form.change(storageName, [])} dataTest={`dhis2-cachecleaner-formsection-deselectall`}>\n                        {deselectButtonLabel}\n                    </Button>\n                </Actions>}\n\n            <Field name={storageName} options={storageKeys.map(formatKeyToOption)} component={CheckboxGroup} />\n        </div>;\n};\nFormSection.propTypes = {\n  deselectButtonLabel: propTypes.string.isRequired,\n  emptyMessage: propTypes.string.isRequired,\n  form: propTypes.shape({\n    change: propTypes.func.isRequired\n  }).isRequired,\n  headline: propTypes.string.isRequired,\n  selectButtonLabel: propTypes.string.isRequired,\n  storageKeys: propTypes.arrayOf(propTypes.string).isRequired,\n  storageName: propTypes.string.isRequired\n};","import { Button, Help } from '@dhis2/ui-core';\nimport { FORM_ERROR } from 'final-form';\nimport i18n from '@dhis2/d2-i18n';\nimport propTypes from '@dhis2/prop-types';\nimport { Form } from '@dhis2/ui-forms';\nimport React from 'react';\nimport { Actions } from '../actions/Actions';\nimport { FormSection } from './FormSection';\nimport styles from './ClearForm.module.css';\n\nconst validate = values => {\n  const errors = {};\n\n  if (!values.localStorageKeys.length && !values.sessionStorageKeys.length && !values.indexedDatabaseKeys.length) {\n    errors[FORM_ERROR] = i18n.t('No data selected');\n  }\n\n  return errors;\n};\n\nexport const ClearForm = ({\n  onSubmit,\n  initialValues,\n  localStorageKeys,\n  sessionStorageKeys,\n  indexedDatabaseKeys\n}) => {\n  const selectAll = form => {\n    form.batch(() => {\n      form.change('localStorageKeys', localStorageKeys);\n      form.change('sessionStorageKeys', sessionStorageKeys);\n      form.change('indexedDatabaseKeys', indexedDatabaseKeys);\n    });\n  };\n\n  const deselectAll = form => {\n    form.batch(() => {\n      form.change('localStorageKeys', []);\n      form.change('sessionStorageKeys', []);\n      form.change('indexedDatabaseKeys', []);\n    });\n  };\n\n  const onFormSubmit = values => {\n    onSubmit(values);\n  };\n\n  return <Form onSubmit={onFormSubmit} initialValues={initialValues} validate={validate}>\n            {({\n      handleSubmit,\n      errors,\n      submitFailed,\n      form\n    }) => <form onSubmit={handleSubmit}>\n                    <Actions>\n                        <Button onClick={() => selectAll(form)} dataTest=\"dhis2-cachecleaner-selectall\">\n                            {i18n.t('Select all')}\n                        </Button>\n\n                        <Button onClick={() => deselectAll(form)} dataTest=\"dhis2-cachecleaner-deselectall\">\n                            {i18n.t('Deselect all')}\n                        </Button>\n\n                        <Button disabled={!!errors[FORM_ERROR]} destructive type=\"submit\" dataTest=\"dhis2-cachecleaner-clear-top\">\n                            {i18n.t('Clear all selected items')}\n                        </Button>\n                    </Actions>\n\n                    <FormSection form={form} emptyMessage={i18n.t('Local storage empty')} selectButtonLabel={i18n.t('Select all local storage items')} deselectButtonLabel={i18n.t('Deselect all local storage items')} headline={i18n.t('Local storage')} storageKeys={localStorageKeys} storageName=\"localStorageKeys\" />\n\n                    <FormSection form={form} emptyMessage={i18n.t('Session storage empty')} selectButtonLabel={i18n.t('Select all session storage items')} deselectButtonLabel={i18n.t('Deselect all session storage items')} headline={i18n.t('Session storage')} storageKeys={sessionStorageKeys} storageName=\"sessionStorageKeys\" />\n\n                    <FormSection form={form} emptyMessage={i18n.t('No indexed databases')} selectButtonLabel={i18n.t('Select all databases')} deselectButtonLabel={i18n.t('Deselect all databases')} headline={i18n.t('Indexed database')} storageKeys={indexedDatabaseKeys} storageName=\"indexedDatabaseKeys\" />\n\n                    <div className={styles.formErrors}>\n                        {errors[FORM_ERROR] && submitFailed && <Help error>{errors[FORM_ERROR]}</Help>}\n                    </div>\n\n                    <Actions>\n                        <Button disabled={!!errors[FORM_ERROR]} destructive type=\"submit\" dataTest=\"dhis2-cachecleaner-clear-bottom\">\n                            {i18n.t('Clear all selected items')}\n                        </Button>\n                    </Actions>\n                </form>}\n        </Form>;\n};\nClearForm.defaultProps = {\n  initialValues: {\n    localStorageKeys: [],\n    sessionStorageKeys: [],\n    indexedDatabaseKeys: []\n  }\n};\nClearForm.propTypes = {\n  indexedDatabaseKeys: propTypes.arrayOf(propTypes.string).isRequired,\n  localStorageKeys: propTypes.arrayOf(propTypes.string).isRequired,\n  sessionStorageKeys: propTypes.arrayOf(propTypes.string).isRequired,\n  onSubmit: propTypes.func.isRequired,\n  initialValues: propTypes.shape({\n    indexedDatabaseKeys: propTypes.arrayOf(propTypes.string),\n    localStorageKeys: propTypes.arrayOf(propTypes.string),\n    sessionStorageKeys: propTypes.arrayOf(propTypes.string)\n  })\n};","export const clearStoragesByKey = (storage, keys) => {\n  // remove keys\n  keys.forEach(key => storage.removeItem(key)); // return removal check\n\n  return keys.reduce((success, key) => {\n    // fail if already failed\n    if (!success) return false;\n    return storage.getItem(key) === null;\n  }, true);\n};","export const reservedStorageKeys = [// exclude methods and props of Storage instances\n...Object.keys(Storage.prototype), // custom dhis2 keys that should not be cleared\n'dhis2.menu.ui.headerBar.title', 'dhis2.menu.ui.headerBar.link', 'dhis2.menu.ui.headerBar.userStyle', 'DHIS2_BASE_URL'];","import { useCallback, useEffect, useState } from 'react';\nimport { getClearableKeys } from './getClearableKeys';\nexport const useClearableStorageKeys = storage => {\n  const [existingKeys, setExistingKeys] = useState([]);\n  const onStorageChange = useCallback(() => {\n    const existing = getClearableKeys(storage);\n    setExistingKeys(existing);\n  }, [storage]);\n  useEffect(() => {\n    onStorageChange();\n  }, [onStorageChange]);\n  return {\n    keys: existingKeys,\n    refetch: onStorageChange\n  };\n};","import { reservedStorageKeys } from './reservedStorageKeys';\n/**\n * @param {Storage} strage\n * @returns {String[]}\n */\n\nexport const getClearableKeys = storage => Object.keys(storage).filter(key => !reservedStorageKeys.includes(key));","import { deleteDb } from './deleteDb';\n/**\n * @param {string} name\n * @returns {Promise.<bool>}\n */\n\nexport const dbExists = name => new Promise((resolve, reject) => {\n  let alreadyExists = true;\n  const request = window.indexedDB.open(name);\n\n  request.onsuccess = () => {\n    request.result.close();\n\n    if (!alreadyExists) {\n      deleteDb(name).then(() => resolve(false));\n    } else {\n      resolve(true);\n    }\n  };\n\n  request.onerror = error => reject(error);\n\n  request.onupgradeneeded = () => alreadyExists = false;\n});","import { dbExists } from './dbExists';\nexport const deleteDb = name => dbExists(name).then(exists => {\n  if (exists) {\n    return new Promise((resolve, reject) => {\n      const request = window.indexedDB.deleteDatabase(name);\n      request.onsuccess = resolve;\n      request.onerror = reject;\n    });\n  }\n\n  return Promise.reject();\n});","export const dhis2DatabaseNames = ['dhis2ou', 'dhis2', 'dhis2tc', 'dhis2ec', 'dhis2de', 'dhis2er', 'dhis2ca'];","import { dbExists } from './dbExists';\nimport { getKeyFromObjectStore } from './getKeyFromObjectStore';\nimport { openDb } from './openDb';\nconst userCachesStoreName = 'userCaches';\nexport const getCaptureAppUserDatabases = () => dbExists('dhis2ca').then(async captureDbExists => {\n  let db;\n  let dbNames = [];\n\n  if (captureDbExists) {\n    try {\n      db = await openDb('dhis2ca');\n      const data = await getKeyFromObjectStore(db, userCachesStoreName, 'accessHistory');\n\n      if (data && data.values) {\n        dbNames = data.values.map(name => `dhis2ca${name}`);\n      }\n    } catch (e) {\n      dbNames = [];\n    } finally {\n      db && db.close();\n    }\n  }\n\n  return dbNames;\n});","/**\n * @param {string} name\n * @returns {Promise.<IDBDatabase>}\n */\nexport const openDb = name => new Promise((resolve, reject) => {\n  const request = window.indexedDB.open(name);\n\n  request.onsuccess = () => resolve(request.result);\n\n  request.onerror = reject;\n});","export const getKeyFromObjectStore = (db, storeName, key) => new Promise((resolve, reject) => {\n  try {\n    const request = db.transaction(storeName).objectStore(storeName).get(key);\n\n    request.onsuccess = event => resolve(event.target.result);\n\n    request.onerror = reject;\n  } catch (e) {\n    reject(e);\n  }\n});","import { useEffect, useState } from 'react';\nimport { getClearableDatabases } from './getClearableDatabases';\nimport { getCaptureAppUserDatabases } from './getCaptureAppUserDatabases';\nexport const useClearableDatabaseKeys = () => {\n  const [refetchCounter, setRefetchCounter] = useState(0);\n\n  const refetch = () => setRefetchCounter(refetchCounter + 1);\n\n  const [loading, setLoading] = useState(true);\n  const [data, setData] = useState({\n    // Contains all databases that are listed in the\n    // \"dhis2DatabaseNames\" file that acutally exist\n    staticDatabases: [],\n    // these won't be listed, but should be deleted\n    // if the static database \"dhis2ca\" is deleted by the user\n    userDatabases: []\n  });\n  useEffect(() => {\n    const operation = async () => {\n      setLoading(true);\n      const staticDatabases = await getClearableDatabases().catch(() => []);\n      const userDatabases = await getCaptureAppUserDatabases().catch(() => []);\n      const allDatabases = {\n        staticDatabases,\n        userDatabases\n      };\n      setData(allDatabases);\n      setLoading(false);\n    };\n\n    operation();\n  }, [refetchCounter]);\n  return {\n    loading,\n    data,\n    refetch\n  };\n};","import { dbExists } from './dbExists';\nimport { dhis2DatabaseNames } from './dhis2DatabaseNames';\n/**\n * @returns {Promise.<String[]>}\n */\n\nexport const getClearableDatabases = () => Promise.all(dhis2DatabaseNames.map(name => dbExists(name).then(exists => exists ? name : null))).then(keys => {\n  const filtered = keys.filter(key => key);\n  return filtered;\n});","import { clearStoragesByKey } from '../../storage';\nimport { clearDatabasesByKey } from '../../indexedDb';\n\nconst clearLocalStorageByKeys = keys => clearStoragesByKey(window.localStorage, keys);\n\nconst clearSessionStorageByKeys = keys => clearStoragesByKey(window.sessionStorage, keys);\n\nexport const deleteValues = async values => {\n  if (values.localStorageKeys) {\n    clearLocalStorageByKeys(values.localStorageKeys);\n  }\n\n  if (values.sessionStorageKeys) {\n    clearSessionStorageByKeys(values.sessionStorageKeys);\n  }\n\n  if (values.indexedDB?.length) {\n    await clearDatabasesByKey(values.indexedDB);\n  }\n};","import { deleteDb } from './deleteDb';\nexport const clearDatabasesByKey = keys => Promise.all(keys.map(deleteDb));","import React from 'react';\nimport i18n from '@dhis2/d2-i18n';\nimport { ClearForm } from '../clearForm';\nimport { deleteValues } from './Home/deleteValues';\nimport { formatDeleteValues } from './Home/formatDeleteValues';\nimport { useClearableDatabaseKeys } from '../indexedDb';\nimport { useClearableStorageKeys } from '../storage';\nimport styles from './Home.module.css';\nexport const Home = () => {\n  const {\n    keys: localStorageKeys,\n    refetch: refetchLocalStorageKeys\n  } = useClearableStorageKeys(window.localStorage);\n  const {\n    keys: sessionStorageKeys,\n    refetch: refetchSessionStorageKeys\n  } = useClearableStorageKeys(window.sessionStorage);\n  const {\n    loading,\n    error,\n    data: indexedDatabaseKeys,\n    refetch: refetchIndexedDatabaseKeys\n  } = useClearableDatabaseKeys();\n  const {\n    staticDatabases,\n    userDatabases\n  } = indexedDatabaseKeys;\n\n  const refetch = async () => {\n    refetchLocalStorageKeys();\n    refetchSessionStorageKeys();\n    await refetchIndexedDatabaseKeys();\n  };\n\n  const onSubmit = async values => {\n    const formattedValues = formatDeleteValues(values, userDatabases);\n    await deleteValues(formattedValues);\n    await refetch();\n  };\n\n  const showContent = !loading && !error;\n  return <div className={styles.container}>\n            {loading && <p data-test=\"dhis2-cachecleaner-loading\">\n                    {i18n.t('Loading clearable data...')}\n                </p>}\n            {error && i18n.t(`Something went wrong: ${error.message}`)}\n            {showContent && <>\n                    <h1 className={styles.headline} data-test=\"dhis2-cachecleaner-homeheadline\">\n                        {i18n.t('DHIS 2 browser cache cleaner')}\n                    </h1>\n\n                    <ClearForm // keep these so the previously selected values\n      // are kept for rejection in the confirmation step\n      localStorageKeys={localStorageKeys} sessionStorageKeys={sessionStorageKeys} indexedDatabaseKeys={staticDatabases} onSubmit={onSubmit} />\n                </>}\n        </div>;\n};","export const formatDeleteValues = (values, userDatabases) => {\n  const {\n    indexedDatabaseKeys,\n    localStorageKeys,\n    sessionStorageKeys\n  } = values; // user databases should only be cleared when the \"dhis2ca\" db is cleared\n\n  const shouldDeleteUserDatabases = indexedDatabaseKeys?.includes('dhis2ca') && userDatabases?.length;\n  return {\n    localStorageKeys: localStorageKeys || [],\n    sessionStorageKeys: sessionStorageKeys || [],\n    indexedDB: [...(indexedDatabaseKeys || []), ...(shouldDeleteUserDatabases ? userDatabases : [])]\n  };\n};","import { CssVariables } from '@dhis2/ui-core';\nimport React from 'react';\nimport { Home } from './views';\nexport default function App() {\n  return <div className=\"container\">\n            <CssVariables colors spacers />\n            <Home />\n        </div>;\n}"],"sourceRoot":""}