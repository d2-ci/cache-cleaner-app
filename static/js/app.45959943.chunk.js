(this["webpackJsonp@dhis2/app-shell"]=this["webpackJsonp@dhis2/app-shell"]||[]).push([[127],{174:function(e,a,t){e.exports={actions:"Actions_actions__1BcAq"}},175:function(e,a,t){e.exports={container:"FormSection_container__20Fh9",groupHeadline:"FormSection_groupHeadline__3kOHC"}},176:function(e,a,t){e.exports={actions:"ClearForm_actions__2P0VA",action:"ClearForm_action__243lJ",groupHeadline:"ClearForm_groupHeadline__2C-rb"}},177:function(e,a,t){e.exports={container:"Home_container__2aYrM",headline:"Home_headline__2WsGZ"}},178:function(e,a,t){"use strict";t.r(a),t.d(a,"default",(function(){return H}));var s=t(9),n=t(1),c=t.n(n),l=t(5),o=t(170),r=t(169),i=t(174),d=t.n(i);const m=({children:e})=>c.a.createElement("div",{className:d.a.actions},c.a.createElement(s.b,null,e));var h=t(173),u=t(175),g=t.n(u);const b=e=>({label:e,value:e}),y=({deselectButtonLabel:e,emptyMessage:a,form:t,headline:n,selectButtonLabel:l,storageKeys:o,storageName:i})=>{const d=i.toLowerCase();return c.a.createElement("div",{className:g.a.container,"data-test":"dhis2-cachecleaner-".concat(d)},c.a.createElement("h2",{className:g.a.groupHeadline},n),!o.length&&c.a.createElement("p",{"data-test":"dhis2-cachecleaner-emptystoragemessage"},a),!!o.length&&c.a.createElement(m,null,c.a.createElement(s.a,{onClick:()=>t.change(i,o),dataTest:"dhis2-cachecleaner-formsection-selectall"},l),c.a.createElement(s.a,{onClick:()=>t.change(i,[]),dataTest:"dhis2-cachecleaner-formsection-deselectall"},e)),c.a.createElement(r.a,{name:i,options:o.map(b),component:h.a}))};var S=t(176),p=t.n(S);const E=e=>{const a={};return e.localStorageKeys.length||e.sessionStorageKeys.length||e.indexedDatabaseKeys.length||(a[o.a]=l.a.t("No data selected")),a},K=({onSubmit:e,initialValues:a,localStorageKeys:t,sessionStorageKeys:n,indexedDatabaseKeys:i})=>c.a.createElement(r.b,{onSubmit:a=>{e(a)},initialValues:a,validate:E},({handleSubmit:e,errors:a,submitFailed:r,form:d})=>c.a.createElement("form",{onSubmit:e},c.a.createElement(m,null,c.a.createElement(s.a,{onClick:()=>(e=>{e.batch(()=>{e.change("localStorageKeys",t),e.change("sessionStorageKeys",n),e.change("indexedDatabaseKeys",i)})})(d),dataTest:"dhis2-cachecleaner-selectall"},l.a.t("Select all")),c.a.createElement(s.a,{onClick:()=>(e=>{e.batch(()=>{e.change("localStorageKeys",[]),e.change("sessionStorageKeys",[]),e.change("indexedDatabaseKeys",[])})})(d),dataTest:"dhis2-cachecleaner-deselectall"},l.a.t("Deselect all")),c.a.createElement(s.a,{disabled:!!a[o.a],destructive:!0,type:"submit",dataTest:"dhis2-cachecleaner-clear-top"},l.a.t("Clear all selected items"))),c.a.createElement(y,{form:d,emptyMessage:l.a.t("Local storage empty"),selectButtonLabel:l.a.t("Select all local storage items"),deselectButtonLabel:l.a.t("Deselect all local storage items"),headline:l.a.t("Local storage"),storageKeys:t,storageName:"localStorageKeys"}),c.a.createElement(y,{form:d,emptyMessage:l.a.t("Session storage empty"),selectButtonLabel:l.a.t("Select all session storage items"),deselectButtonLabel:l.a.t("Deselect all session storage items"),headline:l.a.t("Session storage"),storageKeys:n,storageName:"sessionStorageKeys"}),c.a.createElement(y,{form:d,emptyMessage:l.a.t("No indexed databases"),selectButtonLabel:l.a.t("Select all databases"),deselectButtonLabel:l.a.t("Deselect all databases"),headline:l.a.t("Indexed database"),storageKeys:i,storageName:"indexedDatabaseKeys"}),c.a.createElement("div",{className:p.a.formErrors},a[o.a]&&r&&c.a.createElement(s.f,{error:!0},a[o.a])),c.a.createElement(m,null,c.a.createElement(s.a,{disabled:!!a[o.a],destructive:!0,type:"submit",dataTest:"dhis2-cachecleaner-clear-bottom"},l.a.t("Clear all selected items")))));K.defaultProps={initialValues:{localStorageKeys:[],sessionStorageKeys:[],indexedDatabaseKeys:[]}};const f=(e,a)=>(a.forEach(a=>e.removeItem(a)),a.reduce((a,t)=>!!a&&null===e.getItem(t),!0)),w=[...Object.keys(Storage.prototype),"dhis2.menu.ui.headerBar.title","dhis2.menu.ui.headerBar.link","dhis2.menu.ui.headerBar.userStyle","DHIS2_BASE_URL"],D=e=>{const[a,t]=Object(n.useState)([]),s=Object(n.useCallback)(()=>{const a=(e=>Object.keys(e).filter(e=>!w.includes(e)))(e);t(a)},[e]);return Object(n.useEffect)(()=>{s()},[s]),{keys:a,refetch:s}},_=e=>new Promise((a,t)=>{let s=!0;const n=window.indexedDB.open(e);n.onsuccess=()=>{n.result.close(),s?a(!0):v(e).then(()=>a(!1))},n.onerror=e=>t(e),n.onupgradeneeded=()=>s=!1}),v=(e,a=!1)=>_(e).then(t=>t?new Promise((a,t)=>{const s=window.indexedDB.deleteDatabase(e);s.onsuccess=a,s.onerror=t}):a?Promise.resolve():Promise.reject()),x=["dhis2ou","dhis2","dhis2tc","dhis2ec","dhis2de","dhis2er","dhis2ca"],B=()=>_("dhis2ca").then(async e=>{let a,t=[];if(e)try{a=await(s="dhis2ca",new Promise((e,a)=>{const t=window.indexedDB.open(s);t.onsuccess=()=>e(t.result),t.onerror=a}));const e=await((e,a,t)=>new Promise((s,n)=>{try{const c=e.transaction(a).objectStore(a).get(t);c.onsuccess=e=>s(e.target.result),c.onerror=n}catch(c){n(c)}}))(a,"userCaches","accessHistory");e&&e.values&&(t=e.values)}catch(n){t=[]}finally{a&&a.close()}var s;return t}),k=()=>{const[e,a]=Object(n.useState)(0),[t,s]=Object(n.useState)(!0),[c,l]=Object(n.useState)({staticDatabases:[],userDatabases:[]});return Object(n.useEffect)(()=>{(async()=>{s(!0);const e=await Promise.all(x.map(e=>_(e).then(a=>a?e:null))).then(e=>e.filter(e=>e)).catch(()=>[]),a=await B().catch(()=>[]);l({staticDatabases:e,userDatabases:a}),s(!1)})()},[e]),{loading:t,data:c,refetch:()=>a(e+1)}},C=async e=>{var a,t;e.localStorageKeys&&(t=e.localStorageKeys,f(window.localStorage,t)),e.sessionStorageKeys&&(e=>{f(window.sessionStorage,e)})(e.sessionStorageKeys),(null===(a=e.indexedDB)||void 0===a?void 0:a.length)&&await(e=>{const a=e.map(e=>v(e,!0));return Promise.all(a)})(e.indexedDB)};var L=t(177),N=t.n(L);const j=()=>{const{keys:e,refetch:a}=D(window.localStorage),{keys:t,refetch:s}=D(window.sessionStorage),{loading:n,error:o,data:r,refetch:i}=k(),{staticDatabases:d,userDatabases:m}=r,h=!n&&!o;return c.a.createElement("div",{className:N.a.container},n&&c.a.createElement("p",{"data-test":"dhis2-cachecleaner-loading"},l.a.t("Loading clearable data...")),o&&l.a.t("Something went wrong: ".concat(o.message)),h&&c.a.createElement(c.a.Fragment,null,c.a.createElement("h1",{className:N.a.headline,"data-test":"dhis2-cachecleaner-homeheadline"},l.a.t("DHIS 2 browser cache cleaner")),c.a.createElement(K,{localStorageKeys:e,sessionStorageKeys:t,indexedDatabaseKeys:d,onSubmit:async e=>{const t=((e,a)=>{const{indexedDatabaseKeys:t,localStorageKeys:s,sessionStorageKeys:n}=e,c=(null===t||void 0===t?void 0:t.includes("dhis2ca"))&&(null===a||void 0===a?void 0:a.length);return{localStorageKeys:s||[],sessionStorageKeys:n||[],indexedDB:[...t||[],...c?a:[]]}})(e,m);await C(t),await(async()=>{a(),s(),await i()})()}})))};function H(){return c.a.createElement("div",{className:"container"},c.a.createElement(s.e,{colors:!0,spacers:!0}),c.a.createElement(j,null))}}}]);
//# sourceMappingURL=app.45959943.chunk.js.map